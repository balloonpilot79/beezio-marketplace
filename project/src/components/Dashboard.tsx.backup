import React, { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../lib/supabase';
// Unused imports removed
import { Link } from 'react-router-dom';
import SellerProducts from './SellerProducts';
// import SellerIntegrations from './SellerIntegrations';
import BuyerOrders from './BuyerOrders';
// import BuyerWatching from './BuyerWatching';
import BuyerSubscriptions from './BuyerSubscriptions';
import AffiliateGamification from './AffiliateGamification';
import MiniLeaderboard from './MiniLeaderboard';

interface DashboardStats {
  totalEarnings: number;
  totalProducts: number;
  totalSales: number;
  activeCommissions: number;
}

const Dashboard: React.FC = () => {
  const { profile } = useAuth();
  const navigate = useNavigate();
  const { role: urlRole } = useParams<{ role: string }>();
  const [stats, setStats] = useState<DashboardStats>({
    totalEarnings: 0,
    totalProducts: 0,
    totalSales: 0,
    activeCommissions: 0,
  });
  const [loading, setLoading] = useState(true);

  // Redirect if not authenticated
  useEffect(() => {
    if (!profile) {
      navigate('/');
      return;
    }
    
    // If URL has a role parameter, check if it matches user's actual role
    if (urlRole && profile.role !== urlRole) {
      // Redirect to correct role-based dashboard
      navigate(`/dashboard/${profile.role}`, { replace: true });
      return;
    }
    
    // If no role in URL but user is authenticated, redirect to role-based dashboard
    if (!urlRole) {
      navigate(`/dashboard/${profile.role}`, { replace: true });
    }
  }, [profile, urlRole, navigate]);

  useEffect(() => {
    if (profile) {
      fetchDashboardData();
    }
  }, [profile]);

  const fetchDashboardData = async () => {
    if (!profile) {
      setLoading(false);
      return;
    }
    
    setLoading(true);
    try {
      // Fetch stats based on user role
      const promises = [];

      if (profile.role === 'seller' || profile.role === 'admin') {
        // Fetch seller stats
        promises.push(
          supabase
            .from('products')
            .select('*')
            .eq('seller_id', profile.id)
        );
      }

      if (profile.role === 'affiliate' || profile.role === 'admin') {
        // Fetch affiliate stats
        promises.push(
          supabase
            .from('commissions')
            .select('*')
            .eq('affiliate_id', profile.id)
        );
      }

      const results = await Promise.all(promises);
      
      // Process results and update stats
      const newStats = { ...stats };
      
      if (results[0]) {
        newStats.totalProducts = results[0].data?.length || 0;
      }
      
      if (results[1]) {
        const commissions = results[1].data || [];
        newStats.activeCommissions = commissions.filter(c => c.status === 'pending').length;
        newStats.totalEarnings = commissions
          .filter(c => c.status === 'paid')
          .reduce((sum, c) => sum + (c.amount || 0), 0);
      }
      
      setStats(newStats);
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
    } finally {
      setLoading(false);
    }
  };

// Unused StatCard component removed

  if (loading) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-honey-50 min-h-screen">
        <div className="animate-pulse">
          <div className="h-8 bg-honey-300 rounded w-1/4 mb-8"></div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            {[...Array(4)].map((_, i) => (
              <div 
                key={i} 
                className="h-32 bg-honey-200 floating" 
                style={{ 
                  clipPath: 'polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%)',
                  animationDelay: `${i * 0.2}s`
                }}
              ></div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Seller Dashboard Only
  if (profile?.role === 'seller') {
    const storeUrl = `${window.location.origin}/store/${profile.id}`;
    return (
      <div className="min-h-screen bg-hive-gradient">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Header with Bee Theme */}
          <div className="text-center mb-8">
            <div className="flex justify-center mb-4">
              <div 
                className="w-16 h-16 bg-honey-gradient shadow-xl floating"
                style={{ clipPath: 'polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%)' }}
              >
                <div className="flex items-center justify-center h-full">
                  <span className="text-2xl">ğŸª</span>
                </div>
              </div>
            </div>
            <h1 className="text-4xl font-display font-bold text-bee-800 mb-2">
              Welcome to Your Hive, {profile.full_name}! ğŸ
            </h1>
            <p className="text-bee-600 text-lg">Manage your products and watch your business buzz with activity</p>
          </div>

          <section className="mb-8">
            <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
              <span className="mr-3">ğŸª</span>
              My Storefront
            </h2>
            <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
              <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
              <div className="relative">
                <div className="text-bee-600 text-sm mb-2 font-semibold">ğŸ”— Your unique store link:</div>
                <a 
                  href={storeUrl} 
                  className="text-honey-600 hover:text-honey-700 underline break-all font-medium transition-colors" 
                  target="_blank" 
                  rel="noopener noreferrer"
                >
                  {storeUrl}
                </a>
                <div className="mt-4 flex gap-3">
                  <Link 
                    to={`/store/${profile.id}`}
                    className="btn-honey text-sm px-4 py-2"
                  >
                    ğŸ‘€ Preview Store
                  </Link>
                  <Link 
                    to="/store-customization"
                    className="bg-nectar hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors"
                  >
                    ğŸ¨ Customize Store
                  </Link>
                </div>
              </div>
            </div>
          </section>
          
          <section className="mb-8">
            <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
              <span className="mr-3">ğŸ“¦</span>
              My Products
            </h2>
            <SellerProducts sellerId={profile.id} />
          <Link
            to="/dashboard/products/add"
            className="mt-4 inline-block bg-amber-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-amber-600 transition-colors"
          >
            Add New Product
          </Link>
        </section>
        
        {/* Seller Tools Section */}
        <section className="mb-8">
          <h2 className="text-xl font-semibold mb-4">ğŸ› ï¸ Seller Tools & Features</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸª Custom Storefront</h3>
              <p className="text-gray-600 text-sm mb-4">Personalized store with your branding, custom domain support, and mobile-responsive design.</p>
              <div className="flex items-center space-x-3">
                <a href={storeUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-700 text-sm font-medium">View Store â†’</a>
                <Link to="/dashboard/store-settings" className="text-blue-600 hover:text-blue-700 text-sm font-medium">Customize â†’</Link>
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ”— API Integration</h3>
              <p className="text-gray-600 text-sm mb-4">RESTful API for inventory sync, order management, and real-time analytics integration.</p>
              <Link to="/dashboard/integrations" className="text-green-600 hover:text-green-700 text-sm font-medium">API Documentation â†’</Link>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ“Š Analytics Dashboard</h3>
              <p className="text-gray-600 text-sm mb-4">Real-time sales tracking, customer insights, and performance metrics with exportable reports.</p>
              <button className="text-purple-600 hover:text-purple-700 text-sm font-medium">View Analytics â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-amber-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ’³ Payment Processing</h3>
              <p className="text-gray-600 text-sm mb-4">Integrated Stripe payments, subscription billing, and automated payout management.</p>
              <button className="text-amber-600 hover:text-amber-700 text-sm font-medium">Configure Payments â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ“¦ Inventory Management</h3>
              <p className="text-gray-600 text-sm mb-4">Bulk product uploads, stock tracking, automated reorder alerts, and SKU management.</p>
              <Link to="/dashboard/products/add" className="text-red-600 hover:text-red-700 text-sm font-medium">Manage Inventory â†’</Link>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ¯ Marketing Tools</h3>
              <p className="text-gray-600 text-sm mb-4">Discount codes, promotional campaigns, email marketing integration, and social media tools.</p>
              <button className="text-indigo-600 hover:text-indigo-700 text-sm font-medium">Marketing Hub â†’</button>
            </div>
          </div>
        
        <section className="mb-8">
          <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
            <span className="mr-3">ğŸ“Š</span>
            Sales Analytics
          </h2>
          <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
            <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
            <div className="relative text-center">
              <span className="text-4xl mb-4 block">ğŸ“ˆ</span>
              <p className="text-bee-600">Your sales analytics dashboard is buzzing with potential!</p>
              <p className="text-bee-500 text-sm mt-2">Sales charts and statistics coming soon...</p>
            </div>
          </div>
        </section>
        
        <section className="mb-8">
          <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
            <span className="mr-3">ğŸ’°</span>
            Payouts & Earnings
          </h2>
          <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
            <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
            <div className="relative text-center">
              <span className="text-4xl mb-4 block">ğŸ¯</span>
              <p className="text-bee-600">Sweet earnings await! Track your honey-making progress here.</p>
              <p className="text-bee-500 text-sm mt-2">Earnings and payout status dashboard coming soon...</p>
            </div>
          </div>
        </section>
        
        <section>
          <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
            <span className="mr-3">ğŸ”—</span>
            API Integrations
          </h2>
          <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
            <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
            <div className="relative">
              <p className="text-bee-600 mb-4">Connect your favorite platforms to expand your hive's reach!</p>
              <div className="flex gap-3">
                <button className="btn-honey text-sm px-4 py-2">
                  ğŸ’³ Connect Stripe
                </button>
                <Link 
                  to="/integrations"
                  className="bg-nectar hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors"
                >
                  ğŸŒ View All Integrations
                </Link>
              </div>
            </div>
          </div>
        </section>
        </div>
      </div>
    );
  }

  // Affiliate Dashboard Only
  if (profile?.role === 'affiliate') {
    const affiliateStoreUrl = `${window.location.origin}/affiliate/${profile.id}`;
    return (
      <div className="min-h-screen bg-hive-gradient">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Header with Bee Theme */}
          <div className="text-center mb-8">
            <div className="flex justify-center mb-4">
              <div 
                className="w-16 h-16 bg-nectar shadow-xl floating"
                style={{ clipPath: 'polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%)' }}
              >
                <div className="flex items-center justify-center h-full">
                  <span className="text-2xl">ğŸ¤</span>
                </div>
              </div>
            </div>
            <h1 className="text-4xl font-display font-bold text-bee-800 mb-2">
              Welcome to Your Affiliate Hive, {profile.full_name}! ğŸ
            </h1>
            <p className="text-bee-600 text-lg">Promote products and earn sweet commissions in our buzzing marketplace</p>
          </div>
        
        {/* Gamification Section */}
        <section className="mb-8">
          <AffiliateGamification />
        </section>

        {/* Leaderboard Section */}
        <section className="mb-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <MiniLeaderboard metric="points" timeframe="month" />
            <MiniLeaderboard metric="commission" timeframe="month" />
          </div>
        </section>
        
        <section className="mb-8">
          <h2 className="text-xl font-semibold mb-2">My Affiliate Storefront</h2>
          <div className="bg-white rounded shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
              <div className="text-gray-700 text-sm mb-2">Your unique affiliate store link:</div>
              <a href={affiliateStoreUrl} className="text-blue-600 underline break-all" target="_blank" rel="noopener noreferrer">{affiliateStoreUrl}</a>
            </div>
          </div>
        </section>
        
        {/* Affiliate Tools Section */}
        <section className="mb-8">
          <h2 className="text-xl font-semibold mb-4">ğŸš€ Affiliate Tools & Features</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸª Personal Storefront</h3>
              <p className="text-gray-600 text-sm mb-4">Branded affiliate store with curated products, custom layouts, and your unique tracking codes.</p>
              <a href={affiliateStoreUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-700 text-sm font-medium">View Your Store â†’</a>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ”— Smart Link Generator</h3>
              <p className="text-gray-600 text-sm mb-4">Auto-generate tracked affiliate links for any product with built-in analytics and conversion tracking.</p>
              <button className="text-green-600 hover:text-green-700 text-sm font-medium">Generate Links â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ›ï¸ Store Integrations</h3>
              <p className="text-gray-600 text-sm mb-4">Import products from Shopify, Printify, Etsy, and other platforms to promote with your affiliate links.</p>
              <Link to="/dashboard/integrations" className="text-indigo-600 hover:text-indigo-700 text-sm font-medium">Connect Stores â†’</Link>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ“Š Performance Analytics</h3>
              <p className="text-gray-600 text-sm mb-4">Real-time click tracking, conversion rates, earnings reports, and top-performing product insights.</p>
              <button className="text-purple-600 hover:text-purple-700 text-sm font-medium">View Analytics â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-amber-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ¨ Creative Assets</h3>
              <p className="text-gray-600 text-sm mb-4">Banners, product images, email templates, and social media content optimized for conversions.</p>
              <button className="text-amber-600 hover:text-amber-700 text-sm font-medium">Download Assets â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ“± Mobile App</h3>
              <p className="text-gray-600 text-sm mb-4">iOS and Android apps for link generation, earnings tracking, and product discovery on-the-go.</p>
              <button className="text-red-600 hover:text-red-700 text-sm font-medium">Download App â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ† Gamification System</h3>
              <p className="text-gray-600 text-sm mb-4">Earn points, unlock badges, climb leaderboards, and access exclusive high-commission products.</p>
              <button className="text-indigo-600 hover:text-indigo-700 text-sm font-medium">View Achievements â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-pink-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ’¬ Community Hub</h3>
              <p className="text-gray-600 text-sm mb-4">Connect with top affiliates, share strategies, access exclusive webinars, and get mentorship.</p>
              <button className="text-pink-600 hover:text-pink-700 text-sm font-medium">Join Community â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-teal-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ”” Smart Notifications</h3>
              <p className="text-gray-600 text-sm mb-4">Real-time alerts for new products, commission increases, and optimization opportunities.</p>
              <button className="text-teal-600 hover:text-teal-700 text-sm font-medium">Configure Alerts â†’</button>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-orange-500">
              <h3 className="font-semibold text-gray-900 mb-2">ğŸ’° Payment Flexibility</h3>
              <p className="text-gray-600 text-sm mb-4">Multiple payout options: PayPal, bank transfer, crypto, or reinvest earnings for bonus commissions.</p>
              <button className="text-orange-600 hover:text-orange-700 text-sm font-medium">Payment Settings â†’</button>
            </div>
          </div>
        </section>
        
        <section className="mb-8">
          <h2 className="text-xl font-semibold mb-2">Commissions</h2>
          <div className="bg-white rounded shadow p-4">[Earnings stats here]</div>
        </section>
        <section className="mb-8">
          <h2 className="text-xl font-semibold mb-2">Affiliate Links</h2>
          <div className="bg-white rounded shadow p-4">[List and generate links here]</div>
        </section>
        <section className="mb-8">
          <h2 className="text-xl font-semibold mb-2">Performance</h2>
          <div className="bg-white rounded shadow p-4">[Clicks, conversions, top products here]</div>
        </section>
        </section>
        </div>
      </div>
    );
  }

  // Buyer Dashboard Only
  if (profile?.role === 'buyer') {
    return (
      <div className="min-h-screen bg-hive-gradient">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Header with Bee Theme */}
          <div className="text-center mb-8">
            <div className="flex justify-center mb-4">
              <div 
                className="w-16 h-16 bg-honey-500 shadow-xl floating"
                style={{ clipPath: 'polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%)' }}
              >
                <div className="flex items-center justify-center h-full">
                  <span className="text-2xl">ğŸ›’</span>
                </div>
              </div>
            </div>
            <h1 className="text-4xl font-display font-bold text-bee-800 mb-2">
              Welcome to Your Shopping Hive, {profile.full_name}! ğŸ
            </h1>
            <p className="text-bee-600 text-lg">Discover amazing products and manage your purchases</p>
          </div>

          <section className="mb-8">
            <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
              <span className="mr-3">ğŸ“¦</span>
              Order History
            </h2>
            <BuyerOrders buyerId={profile.id} />
          </section>

          <section className="mb-8">
            <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
              <span className="mr-3">ğŸ”„</span>
              Active Subscriptions
            </h2>
            <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
              <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
              <div className="relative">
                <BuyerSubscriptions buyerId={profile.id} />
              </div>
            </div>
          </section>

          <section className="mb-8">
            <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
              <span className="mr-3">â¤ï¸</span>
              Saved Items
            </h2>
            <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
              <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
              <div className="relative text-center">
                <span className="text-4xl mb-4 block">ğŸ’</span>
                <p className="text-bee-600">Your saved items and wishlist will appear here!</p>
                <p className="text-bee-500 text-sm mt-2">Start saving products you love...</p>
              </div>
            </div>
          </section>

          <section className="mb-8">
            <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center">
              <span className="mr-3">ğŸ¯</span>
              Recommended Products
            </h2>
            <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
              <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
              <div className="relative text-center">
                <span className="text-4xl mb-4 block">ğŸ</span>
                <p className="text-bee-600">Personalized product recommendations coming soon!</p>
                <p className="text-bee-500 text-sm mt-2">We'll suggest products based on your shopping history...</p>
              </div>
            </div>
          </section>

          <section>
            <div className="bg-white rounded-lg shadow-lg border border-honey-200 p-6 relative overflow-hidden">
              <div className="absolute inset-0 bg-honeycomb opacity-5"></div>
              <div className="relative text-center">
                <h2 className="text-2xl font-display font-bold text-bee-800 mb-4 flex items-center justify-center">
                  <span className="mr-3">ğŸ</span>
                  Need Help?
                </h2>
                <p className="text-bee-600 mb-4">Our support team is here to help you buzz through any questions!</p>
                <button className="btn-honey text-sm px-6 py-3">
                  ğŸ’¬ Contact Support
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    );
  }

  return null;

// ...existing code...
export default Dashboard;